<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oracle.coffee.MfgMapper">

	<select id="magamNext" resultType="String">
		SELECT TO_CHAR(TO_DATE(Max(yrmo),'YYMMDD')+1 , 'YYYY-MM-DD') as magam FROM MAGAM WHERE magam_status = 1
	</select>

	<insert id="mfgSeqRegister" parameterType="MfgDTO" useGeneratedKeys="true" keyProperty="mfg_code">
		INSERT INTO MFG(mfg_code , mfg_reg_code , mfg_reg_date)
		VALUES (MFG_SEQ.nextval , #{mfg_reg_code} , #{mfg_reg_date})
		
		<selectKey keyProperty="mfg_code" resultType="Int" order="AFTER">
			select MFG_SEQ.CURRVAL From dual
		</selectKey>
		
	</insert>

	<insert id="mfgRegister" parameterType="MfgDetailDTO">
		INSERT INTO MFG_DETAIL(mfg_code , product_code , mfg_amount , mfg_request_date , mfg_due_date , mfg_status , mfg_contents)
		VALUES (#{mfg_code} , #{product_code} , #{mfg_amount} , #{mfg_request_date, jdbcType=TIMESTAMP},
		#{mfg_due_date, jdbcType=VARCHAR},
		#{mfg_status},
		#{mfg_contents, jdbcType=VARCHAR})
	</insert>
	
	<select id="mfgTotal" resultType="Int">
		SELECT COUNT(*) FROM MFG
	</select>
	
	<select id="mfgList" parameterType="MfgDTO" resultType="MfgDTO">
		SELECT * FROM (
            SELECT rownum rw , mfgAll.* FROM (
                SELECT mfg.* , emp.emp_name , dept.dept_name FROM MFG 
                         LEFT OUTER JOIN EMP 
                            ON mfg.mfg_reg_code = emp.emp_code
                         LEFT OUTER JOIN DEPT
                            ON emp.emp_dept_code = dept.dept_code
                         ORDER BY mfg_code DESC
                            ) mfgAll
            ) WHERE rw BETWEEN #{start} and #{end}
             
	</select>
	
	<select id="mfgDetail" parameterType="MfgDetailDTO" resultType="MfgDetailDTO">
		SELECT detail.* , mfg.mfg_reg_date , pro.product_name , bun.cd_contents , emp.emp_name , emp.emp_tel , dept.dept_name
         FROM mfg_detail detail
         LEFT OUTER JOIN mfg mfg
            ON detail.mfg_code = mfg.mfg_code
         LEFT OUTER JOIN PRODUCT pro
            ON detail.product_code = pro.product_code
         LEFT OUTER JOIN BUNRYU bun
            ON pro.product_unit = bun.mcd
         LEFT OUTER JOIN EMP emp
            ON mfg.mfg_reg_code = emp.emp_code
         LEFT OUTER JOIN DEPT dept
            ON emp.emp_dept_code = dept.dept_code
         WHERE detail.mfg_code = #{mfg_code}
         AND bun.bcd = 750
		
	</select>
	
	<select id="mfgStatus" parameterType="MfgDetailDTO" resultType="MfgDetailDTO">
		SELECT * FROM MFG_DETAIL WHERE mfg_code = #{mfg_code}
	</select>
	
	<select id="mfgUpdateForm" parameterType="MfgDetailDTO" resultType="MfgDetailDTO">
		SELECT detail.* , mfg.mfg_reg_date , pro.product_name , bun.cd_contents , emp.emp_name , emp.emp_tel , dept.dept_name
			FROM mfg_detail detail
			LEFT OUTER JOIN mfg mfg
			   ON detail.mfg_code = mfg.mfg_code
			LEFT OUTER JOIN PRODUCT pro
			   ON detail.product_code = pro.product_code
			LEFT OUTER JOIN BUNRYU bun
			   ON pro.product_unit = bun.mcd
			LEFT OUTER JOIN EMP emp
			   ON mfg.mfg_reg_code = emp.emp_code
			LEFT OUTER JOIN DEPT dept
			   ON emp.emp_dept_code = dept.dept_code
			WHERE detail.mfg_code = #{mfg_code}
			AND bun.bcd = 750
			AND detail.mfg_status = 1
		
	</select>
	
	<select id="existingList" parameterType="Int" resultType="MfgDetailDTO">
		SELECT * FROM MFG_DETAIL WHERE mfg_code = #{mfg_code} AND mfg_status = 1
	</select>
	
	<delete id="mfgDelete" parameterType="MfgDetailDTO">
		DELETE FROM MFG_DETAIL WHERE mfg_code = #{mfg_code} AND product_code = #{product_code} AND mfg_status = 1
	</delete>
	
	<insert id="mfgInsert" parameterType="MfgDetailDTO">
		INSERT INTO MFG_DETAIL(mfg_code , product_code , mfg_amount , mfg_request_date , mfg_due_date , mfg_status , mfg_contents)
		VALUES (#{mfg_code} , #{product_code} , #{mfg_amount} , #{mfg_request_date, jdbcType=TIMESTAMP} , #{mfg_due_date, jdbcType=VARCHAR} , #{mfg_status} , #{mfg_contents, jdbcType=VARCHAR})
	</insert>
	
	<update id="mfgUpdate" parameterType="MfgDetailDTO">
		UPDATE MFG_DETAIL SET mfg_amount = #{mfg_amount} , mfg_request_date = #{mfg_request_date} WHERE mfg_code = #{mfg_code} AND product_code = #{product_code}
	</update>
	
	<select id="mfgApproveForm" parameterType="MfgDetailDTO" resultType="MfgDetailDTO">
		SELECT * FROM MFG_DETAIL WHERE mfg_code = #{mfg_code}
	</select>
	
	<update id="mfgApproveUpdate" parameterType="MfgDetailDTO">
		UPDATE MFG_DETAIL 
		SET mfg_due_date = #{mfg_due_date , jdbcType=VARCHAR} , mfg_status = #{mfg_status} , mfg_contents = #{mfg_contents , jdbcType=VARCHAR} 
		WHERE mfg_code = #{mfg_code} AND product_code = #{product_code}
	</update>
	
</mapper>
