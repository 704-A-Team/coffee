<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.oracle.coffee.ProductWonMapper">

	<insert id="wonProductSave" parameterType="ProductDto">
		<selectKey keyProperty="product_code" resultType="int" order="BEFORE">
            SELECT PRODUCT_SEQ.NEXTVAL FROM DUAL <!-- Oracle -->
            <!-- MySQL 또는 auto-increment 사용 시: SELECT LAST_INSERT_ID() -->
        </selectKey>
        insert into product
        (
        	 product_code
        	,product_name
        	,product_unit
        	,product_type
        	,product_weight
        	,product_isorder
        	,product_isdel
        	,product_reg_code
        	,product_reg_date 
        )
        values
        (
        	 #{product_code}
        	,#{product_name}
        	,#{product_unit}
        	,#{product_type}
        	,#{product_weight}
        	,#{product_isorder}
        	,#{product_isdel}
        	,#{product_reg_code}
        	,sysdate
        )
	</insert>
	
	<!-- <select id="totalProduct" resultType="int">
		select 	count(*) 
		from 	product
	</select> -->
	
	<select id="totalWonProduct" parameterType="ProductDto" resultType="int">
	    select count(*)
	    from product p
	    where p.product_type = 0
	    <if test="searchKeyword != null and searchKeyword != ''">
	        and lower(p.product_name) like '%' || lower(#{searchKeyword}) || '%'
	    </if>
	</select>
	
	<select id="wonProductList" parameterType="ProductDto" resultType="ProductDto">
	    select *
	    from (
	        select rownum rn, a.*
	        from (
	            select 
	                p.*, 
	                bu.cd_contents as unitName,
	                bt.cd_contents as typeName,
	                bi.cd_contents as isorderName,
	                img.file_name  as simage,
	                pp.price	   as price
	            from product p
	            left join bunryu bu 
	                ON p.product_unit 		= bu.mcd and bu.bcd = 750
	            left join bunryu bt 
	                ON p.product_type 		= bt.mcd and bt.bcd = 700
	            left join bunryu bi 
	                ON p.product_isorder 	= bi.mcd and bi.bcd = 800
	            left join (select * 
	            		   from product_img 
	            		   where ord = 0) img
	            	ON p.product_code 		= img.product_code
	            left join (
			        		select 	product_code, MAX(start_date) as max_start_date
			        		from 	product_price
					        group 	by product_code
					      ) pm
			        ON pm.product_code 		= p.product_code
			    left join product_price pp
			        ON pp.product_code 		= p.product_code and pp.start_date = pm.max_start_date
	            where p.product_type = 0
	            <if test="searchKeyword != null and searchKeyword != ''">
	                and lower(p.product_name) like '%' || lower(#{searchKeyword}) || '%'
	            </if>
	            order by p.product_code desc
	        ) a
	    )
	    where rn between #{start} and #{end}
	</select>
	
	<select id="wonProductDetail" parameterType="int" resultType="ProductDto">
		select  p.*, 
	            bu.cd_contents as unitName,
	            bt.cd_contents as typeName,
	            bi.cd_contents as isorderName,
	            e.emp_name	   as regName,
	            pp.price	   as price
	   	from 	product p
	    left join bunryu bu 
	    	ON p.product_unit 		= bu.mcd 		and bu.bcd = 750
	    left join bunryu bt 
	    	ON p.product_type 		= bt.mcd 		and bt.bcd = 700
	    left join bunryu bi 
	    	ON p.product_isorder 	= bi.mcd 	and bi.bcd = 800
    	left join emp e
    		ON p.product_reg_code 	= e.emp_code
    	left join (
	        		select 	product_code, MAX(start_date) as max_start_date
	        		from 	product_price
			        group 	by product_code
			      ) pm
	        ON pm.product_code 		= p.product_code
		left join product_price pp
	        ON pp.product_code 		= p.product_code and pp.start_date = pm.max_start_date
	    where p.product_code = #{product_code}
	</select>
	
	<select id="wonProductImgList" parameterType="int" resultType="ProductImgDTO">
	    select * 
	    from product_img
	    where product_code = #{product_code}
	    order by ord
	</select>
	
	<update id="wonProductModify" parameterType="ProductDto">
	    update product
	    set product_name     	= #{product_name},
	        product_unit     	= #{product_unit},
	        product_type     	= #{product_type},
	        product_weight   	= #{product_weight},
	        product_isorder  	= #{product_isorder},
	        product_isdel    	= #{product_isdel},
	        product_order_pack 	= #{product_order_pack}
	    where product_code   = #{product_code}
	</update>
	
	<update id="wonProductDelete" parameterType="ProductDto">
	    update 	product
	    set 	product_isdel    = #{product_isdel}
	    where 	product_code   = #{product_code}
	</update>

	<select id="productInfo" parameterType="int" resultType="ProductDto" >
		select 	product_code, product_name
		from 	product
		where 	product_type = #{product_type}
	</select>
	
	<select id="productIsList" parameterType="int" resultType="ProductDto">
		select  product_code, product_name
		from 	product
		where 	product_type = #{product_type}
		and 	product_isdel = 0
	</select>
	
	<insert id="wonProductImgSave" parameterType="List">
		INSERT ALL 
		    <foreach collection="list" item="imgDto" separator=" "> <!-- item 이름을 imgDto 등으로 변경 -->
		    INTO  PRODUCT_IMG (product_code, ord, file_name) VALUES
		        (
		            #{imgDto.product_code},
		            #{imgDto.ord},
		            #{imgDto.file_name}
		        )
		    </foreach>
		    SELECT 1 FROM DUAL
	</insert>
	
	<insert id="insertProductImg" parameterType="ProductImgDTO">
	    INSERT INTO product_img (
	        product_code,
	        ord,
	        file_name
	    ) VALUES (
	        #{product_code},
	        #{ord},
	        #{file_name}
	    )
	</insert>
	
	<delete id="deleteProductImgs" parameterType="int">
        DELETE FROM product_img
        WHERE product_code = #{product_code}
    </delete>
	
	<select id="wonProductAllList" resultType="ProductDto">
		select *
		from product
		where product_type = 0
	</select>
	
	<insert id="monthMagamSave" parameterType="ProductDto">
		insert into month_magam (
			month_yrmo,
			month_magam_status,
			product_code,
			month_magam_amount,
			month_magam_reg_code,
			month_magam_reg_date
		) values (
			TO_CHAR(sysdate, 'yyyyMM'),
			0,
			#{product_code},
			0,
			#{product_reg_code},
			sysdate
		)
		
	</insert>
	
	
</mapper>